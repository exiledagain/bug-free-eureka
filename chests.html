<!doctype html>
<html>
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&amp;display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <link rel="stylesheet" href="css/common.css">
    <script src="d2data.js"></script>
    <script src="chest.js"></script>
  </head>
  <body>
    <a href="https://github.com/exiledagain/bug-free-eureka" target="_blank" rel="noopener noreferrer">source</a>
    <table>
      <tr>
        <td style="vertical-align: baseline;">
          <form id="configForm" autocomplete="off">
            <fieldset>
              <legend>Config</legend>
              <table>
                <tr>
                  <td>
                    <label for="version">Version</label>
                  </td>
                  <td>
                    <select id="version" name="version">
                      <option value="s9" selected>S9</option>
                      <option value="lod">LOD</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>
                    <label for="difficulty">Difficulty</label>
                  </td>
                  <td>
                    <select id="difficulty" name="difficulty">
                      <option value="2" selected>Hell</option>
                      <option value="1">Nightmare</option>
                      <option value="0">Normal</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>
                    <label for="players">Party</label>
                  </td>
                  <td>
                    <select id="players" name="players">
                      <option value="1" selected>1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                      <option value="6">6</option>
                      <option value="7">7</option>
                      <option value="8">8</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>
                    <label for="chest">Chest Type</label>
                  </td>
                  <td>
                    <select id="chestType" name="chestType">
                      <option value="normal" selected>Normal</option>
                      <option value="super">Super</option>
                      <option value="sparkly">Sparkly</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>
                    <label for="chestOpt">Chest Opt</label>
                  </td>
                  <td>
                    <select id="chestOpt" name="chestOpt">
                      <option value="0" selected>Unlocked</option>
                      <option value="1">Locked</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>
                    <label for="act">Act</label>
                  </td>
                  <td>
                    <select id="act" name="act">
                      <option value="4" selected>Act 5</option>
                      <option value="3">Act 4</option>
                      <option value="2">Act 3</option>
                      <option value="1">Act 2</option>
                      <option value="0">Act 1</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>
                    <label for="Zone">Zone</label>
                  </td>
                  <td>
                    <select id="zone" name="zone">
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>
                    <label for="magicFind">Magic Find</label>
                  </td>
                  <td>
                    <input id="magicFind" name="magicFind" type="text" value="0" pattern="\d+" maxlength="4" style="width: 5em;">
                  </td>
                </tr>
              </table>
            </fieldset>
          </form>
        </td>
        <td style="vertical-align: baseline;">
          <form id="filterForm" autocomplete="off">
            <fieldset>
              <legend>Filter</legend>
              <table>
                <tr>
                  <td>
                    <label for="low">Low</label>
                  </td>
                  <td>
                    <select id="low" name="low">
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>
                    <label for="high">High</label>
                  </td>
                  <td>
                    <select id="high" name="high">
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>
                    <label for="uniqueItem">Unique</label>
                  </td>
                  <td>
                    <select id="uniqueItem" name="uniqueItem">
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>
                    <label for="setItem">Set</label>
                  </td>
                  <td>
                    <select id="setItem" name="setItem">
                    </select>
                  </td>
                </tr>
              </table>
            </fieldset>
          </form>
        </td>
        <td style="vertical-align: baseline;">
          <form id="filterForm" autocomplete="off">
            <fieldset>
              <legend>Action</legend>
              <table>
                <tr>
                  <td>
                    <label for="click">Click</label>
                  </td>
                  <td>
                    <button id="click" name="click">Drops</button>
                  </td>
                </tr>
              </table>
            </fieldset>
          </form>
        </td>
      </tr>
    </table>
    <table id="result" style="vertical-align: top;"></table>
    <script>
      'use strict'

      class ChestPU {
        static actZones = [
          'Act 1 - Town',
          'Act 2 - Town',
          'Act 3 - Town',
          'Act 4 - Town',
          'Act 5 - Town'
        ]
        // https://github.com/ThePhrozenKeep/D2MOO/blob/559def2d8fd94e1d2f959fa6e4f907a0f221795f/source/D2Game/src/OBJECTS/ObjMode.cpp#L3909
        static levelIds = ['2', '37', '41', '73', '76', '102', '104', '108', '109', '132']

        constructor () {
          document.querySelectorAll('form').forEach(form => {
            form.onsubmit = e => {
              e.preventDefault()
            }
          })
        }

        async setup (version = Diablo2Data.defaultVersion) {
          this.dropper = new ChestDropper()
          await this.dropper.setup(version)
          this.d2data = this.dropper.d2data
          this.strings = new StringResolver([
            `data/${Diablo2Data.defaultVersion}/global/excel/patchstring.tbl`,
            `data/${Diablo2Data.defaultVersion}/global/excel/expansionstring.tbl`,
            `data/${Diablo2Data.defaultVersion}/global/excel/string.tbl`,
          ])
          await this.strings.load()
          this.runes = []
          for (let i = 1; i <= 33; ++i) {
            const rune = `r${i.toString().padStart(2, '0')}`
            this.runes.push({
              id: version !== 'lod' ? `${rune}s` : rune,
              name: this.strings.get(rune).substring(4)
            })
          }
          this.zones = [[]]
          const levels = this.d2data.levels()
          this.levels = levels
          let i = 0
          levels.each(level => {
            if (!level.Id) {
              return
            }
            // act exists in levels.txt but the game does this?
            if (i < 5 && level.Id === levels.first('Name', ChestPU.actZones[i]).Id) {
              this.zones.at(-1).set = new Set(this.zones.at(-1))
              this.zones.push([])
              i += 1
            } else {
              this.zones.at(-1).push(level)
            }
          })
          this.zones.shift()
          this.config()
          this.configRunes()
          this.configUniques()
          this.configSets()
          document.getElementById('configForm').onchange = e => {
            this.config()
          }
          document.getElementById('click').onclick = e => {
            this.simulate()
          }
        }

        reload (version) {
          document.getElementById('click').onclick = undefined
          document.getElementById('configForm').onchange = undefined
          this.setup(version)
        }

        values () {
          return Object.fromEntries(new FormData(document.getElementById('configForm')))
        }

        filters () {
          return Object.fromEntries(new FormData(document.getElementById('filterForm')))
        }

        config () {
          const previous = this.lastValues || {}
          const values = this.values()
          const valuesKey = JSON.stringify(values)
          if (valuesKey === this.lastValues) {
            return
          }
          if (previous.version && previous.version !== values.version) {
            this.lastValues = undefined
            this.lastValuesKey = undefined
            this.reload(values.version)
            return
          }
          this.lastValues = values
          this.lastValuesKey = valuesKey
          if (previous.chestType !== values.chestType) {
            this.configChestOpt(values)
          }
          if (previous.act !== values.act) {
            this.configAct(values)
          }
        }

        configChestOpt (values) {
          const opt = document.getElementById('chestOpt')
          opt.innerHTML = ''
          const frag = document.createDocumentFragment()
          let types
          switch (values.chestType) {
            case 'super':
            case 'normal': {
              types = ['Unlocked', 'Locked']
              break
            }
            case 'sparkly': {
              types = ['Unique', 'Set', 'Rare', 'Magic (3)', 'Magic (2)', 'Magic (1)']
              break
            }
            default: {
              throw new Error(`unknown chest type: ${values.chestType}`)
            }
          }
          types.forEach((type, idx) => {
            const el = document.createElement('option')
            el.value = idx
            el.textContent = type
            frag.appendChild(el)
          })
          frag.firstElementChild.setAttribute('selected', true)
          opt.appendChild(frag)
        }

        configAct (values) {
          const zone = document.getElementById('zone')
          zone.innerHTML = ''
          const frag = document.createDocumentFragment()
          this.zones[values.act].forEach(zone => {
            const el = document.createElement('option')
            el.value = zone.Id
            el.textContent = this.strings.get(zone.LevelName)
            frag.appendChild(el)
          })
          frag.lastElementChild.setAttribute('selected', true)
          zone.appendChild(frag)
        }

        configRunes () {
          const frag = document.createDocumentFragment()
          this.runes.forEach(({ id, name }) => {
            const el = document.createElement('option')
            el.value = id
            el.textContent = name
            frag.appendChild(el)
          })
          frag.lastElementChild.setAttribute('selected', true)
          const low = document.getElementById('low')
          low.innerHTML = ''
          low.appendChild(frag.cloneNode(true))
          const high = document.getElementById('high')
          high.innerHTML = ''
          high.appendChild(frag)
        }

        simulate () {
          const values = this.values()
          const zone = this.levels.first('Id', values.zone)
          const zoneName = this.strings.get(zone.LevelName)
          const act = Number(values.act)
          const difficulty = Number(values.difficulty)
          const levelKey = `MonLvl${difficulty + 1}Ex`
          const level = Number(zone[levelKey])
          const minLevel = Number(this.levels.first('Id', ChestPU.levelIds[act * 2])[levelKey])
          const maxLevel = Number(this.levels.first('Id', ChestPU.levelIds[act * 2 + 1])[levelKey])
          // extra chest tc for each 1/3 of an act
          const offset = ~~((Math.abs(maxLevel - minLevel) + 1) / 3)
          let idx = 0
          if (level >= minLevel + offset) {
            idx = 1
            idx += level >= minLevel + 2 * offset
          }
          const magicFind = Number(values.magicFind)
          const locked = Number(values.chestOpt)
          const tcIdx = 3 * (difficulty * 5 + act) + idx
          const treasureClass = this.dropper.chestTcs[tcIdx]
          const dropClass = Number(values.players)
          const seedLimit = (1 << 16) - 2
          const filters = this.filters()
          const lowIdx = this.runes.findIndex(rune => rune.id === filters.low)
          const set = {}
          for (let i = lowIdx; i < this.runes.length; ++i) {
            set[this.runes[i].id] = true
            if (this.runes[i].id === filters.high) {
              break
            }
          }
          const chestType = values.chestType
          let sim = 'simulateRegular'
          if (chestType === 'super') {
            sim = 'simulateSuper'
          } else if (chestType === 'sparkly') {
            sim = 'simulateSparkly'
          }
          const uniqueItem = filters.uniqueItem
          const setItem = filters.setItem
          const opts = {
            treasureClass,
            itemLevel: level,
            seed: -1,
            chestDropLevel: idx,
            magicFind,
            locked,
            dropClass
          }
          const forceSeed = -1
          const minSeed = forceSeed < 0 ? 0 : forceSeed
          const maxSeed = forceSeed < 0 ? seedLimit : forceSeed + 1
          if (forceSeed >= 0) {
            opts.debug = true
          }
          let found = []
          for (let i = minSeed; i < maxSeed; ++i) {
            opts.seed = i
            const res = this.dropper[sim](opts)
            if (res.some(drop => set[drop.id])) {
              found.push({
                seed: i,
                drops: res
              })
              continue
            }
            if (uniqueItem.length > 0 && res.some(drop => drop.id === uniqueItem && drop.rarity === 'unique')) {
              found.push({
                seed: i,
                drops: res
              })
              continue
            }
            if (setItem.length > 0 && res.some(drop => drop.id === setItem && drop.rarity === 'set')) {
              found.push({
                seed: i,
                drops: res
              })
              continue
            }
          }
          if (this.dropper.debugList) {
            console.log(JSON.stringify(this.dropper.debugList))
          }
          this.result({
            config: {
              values,
              filters
            },
            computed: {
              treasureClass,
              zone: zoneName
            },
            drops: found
          })
        }

        result (output) {
          const query = document.createElement('td')
          query.style.verticalAlign = 'top'
          this.populateQuery(output, query)
          const result = document.createElement('td')
          result.style.verticalAlign = 'top'
          this.populateResult(output, result)
          const tr = document.createElement('tr')
          tr.appendChild(query)
          tr.appendChild(result)
          const tbl = document.getElementById('result')
          tbl.prepend(tr)
        }

        populateQuery ({ config, computed }, query) {
          const p = text => {
            const el = document.createElement('p')
            el.textContent = text
            return el
          }
          const difficulty = ['Normal', 'Nightmare', 'Hell'][config.values.difficulty]
          const players = config.values.players
          const chestType = ({
            normal: 'Normal',
            super: 'Super',
            sparkly: 'Sparkly'
          })[config.values.chestType]
          const chestOpt = ({
            normal: ['Unlocked', 'Locked'],
            super: ['Unlocked', 'Locked'],
            sparkly: ['Unique', 'Set', 'Rare', 'Magic (3)', 'Magic (2)', 'Magic (1)']
          })[config.values.chestType][config.values.chestOpt]
          const act = `Act ${config.values.act + 1}`
          const magicFind = config.values.magicFind
          const version = config.values.version
          const low = this.runes.find(rune => rune.id === config.filters.low).name
          const high = this.runes.find(rune => rune.id === config.filters.high).name
          const zone = computed.zone
          const treasureClass = computed.treasureClass
          const uniqueItem = config.filters.uniqueItem
          const setItem = config.filters.setItem
          query.appendChild(p(`"${zone}" (${version}) P:${players} MF:${magicFind}`))
          query.appendChild(p(`Treasure: ${treasureClass}`))
          query.appendChild(p(`${chestType} ${chestOpt}`))
          query.appendChild(p(`${low} to ${high}`))
          query.appendChild(p(`Unique: ${uniqueItem}`))
          query.appendChild(p(`Set: ${setItem}`))
        }

        populateResult ({ drops }, result) {
          const txt = (text, type = 'p') => {
            const el = document.createElement(type)
            el.textContent = text
            return el
          }
          const style = getComputedStyle(document.documentElement)
          const color = rarity => {
            return style.getPropertyValue(`--d2-color-${rarity}`)
          }
          const max = (1 << 16) - 2
          result.appendChild(txt(`${drops.length} of ${max} ~ ${(drops.length / max * 100).toFixed(6)}%`))
          drops.forEach((drop, idx) => {
            const el = document.createElement('p')
            el.appendChild(txt(`${idx + 1}. 0x${drop.seed.toString(16).toUpperCase().padStart(4, '0')}`, 'span'))
            el.append(' ')
            drop.drops.forEach(({ id, rarity }) => {
              const name = this.getItemName(id)
              el.appendChild(txt(`[${name}]`, 'span'))
              el.append(' ')
              el.lastElementChild.style.color = !name.endsWith('Rune') ? color(rarity) : color('rune')
            })
            result.appendChild(el)
          })
        }

        getItemName (id) {
          const name = this.strings.get(this.dropper.findItem(id).namestr)
          return name.replace(/\xC3.../g, '')
        }

        configUniques () {
          const frag = document.createDocumentFragment()
          const el = document.createElement('option')
          el.value = ''
          el.textContent = 'None'
          frag.appendChild(el)
          const uniques = []
          this.d2data.uniqueItems().each(unique => {
            if (unique.rarity <= 0 || !unique.enabled) {
              return
            }
            uniques.push({
              entry: unique,
              name: this.strings.get(unique.index)
            })
          })
          uniques.sort((a, b) => a.name.localeCompare(b.name))
          uniques.forEach(({ entry, name }) => {
            const el = document.createElement('option')
            el.value = entry.code
            el.textContent = name
            frag.appendChild(el)
          })
          document.getElementById('uniqueItem').appendChild(frag)
        }

        configSets () {
          const frag = document.createDocumentFragment()
          const el = document.createElement('option')
          el.value = ''
          el.textContent = 'None'
          frag.appendChild(el)
          const sets = []
          this.d2data.setItems().each(set => {
            if (set.item.length === 0) {
              return
            }
            sets.push({
              entry: set,
              name: this.strings.get(set.index)
            })
          })
          sets.sort((a, b) => a.name.localeCompare(b.name))
          sets.forEach(({ entry, name }) => {
            const el = document.createElement('option')
            el.value = entry.item
            el.textContent = name
            frag.appendChild(el)
          })
          document.getElementById('setItem').appendChild(frag)
        }
      }
      new ChestPU().setup()
    </script>
  </body>
</html>
