<!doctype html>
<html>
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&amp;display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <link rel="stylesheet" href="css/common.css">
    <script src="d2data.js"></script>
  </head>
  <body>
    <table>
      <tbody>
        <tr>
          <td>
            <select id="file"></select>
          </td>
        </tr>
      </tbody>
    </table>
    <div id="content"></div>
    <script>
      const version = Diablo2Data.defaultVersion
      const files = [
        'Armor.txt',
        'AutoMagic.txt',
        'CharStats.txt',
        'CubeMain.txt',
        'Experience.txt',
        'ItemRatio.txt',
        'ItemStatCost.txt',
        'ItemTypes.txt',
        'Levels.txt',
        'MagicPrefix.txt',
        'MagicSuffix.txt',
        'Misc.txt',
        'MonLvl.txt',
        'MonStats.txt',
        'MonStats2.txt',
        'MonType.txt',
        'ObjGroup.txt'
        'Properties.txt',
        'QualityItems.txt',
        'Runes.txt',
        'SetItems.txt',
        'Skilldesc.txt',
        'Skills.txt',
        'SuperUniques.txt',
        'TreasureClassEx.txt',
        'UniqueItems.txt',
        'Weapons.txt',
      ]
      const getParameter = key => {
        const params = new URLSearchParams(window.location.search)
        return params.get(key)
      }
      const setParameter = (key, value) => {
        const params = new URLSearchParams(window.location.search)
        if (typeof value !== 'string' || value.length === 0) {
          params.delete(key)
        } else {
          params.set(key, encodeURIComponent(value))
        }
        window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}${window.location.hash}`)
      }
      const loader = new DataLoader()
      function populate (container) {
        const select = document.querySelector('#file')
        select.innerHTML = ''
        files.forEach(file => {
          const el = document.createElement('option')
          el.textContent = file
          el.value = file
          select.appendChild(el)
        })
        const filename = getParameter('filename')
        if (files.includes(filename)) {
          select.selectedIndex = files.indexOf(filename)
        }
        select.onchange = async e => {
          const filename = select.value
          container.innerHTML = ''
          const raw = await loader.load(version, filename)
          if (filename === select.value) {
            new DataFrameView(raw).populate(container)
            window.table = raw
            setParameter('filename', filename)
          }
        }
        select.onchange()
      }
      async function Load () {
        populate(document.querySelector('#content'))
      }
      requestAnimationFrame(Load)
    </script>
  </body>
</html>
