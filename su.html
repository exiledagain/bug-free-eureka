<!doctype html>
<html>
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&amp;display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <link rel="stylesheet" href="css/common.css">
    <script src="d2data.js"></script>
  </head>
  <body>
    <table>
      <tbody>
        <tr>
          <td>
            <input id="search" type="text">
          </td>
        </tr>
      </tbody>
    </table>
    <div id="content"></div>
    <script>
      const version = 's9'
      const strings = new StringResolver([
        `data/${version}/global/excel/patchstring.tbl`,
        `data/${version}/global/excel/expansionstring.tbl`,
        `data/${version}/global/excel/string.tbl`,
      ])
      class SuperUnique {
        static sets = {
          'Bishibosh': { area: 'Act 1 - Wilderness 2' },
          'Bonebreak': { area: 'Act 1 - Crypt 1 A' },
          'Coldcrow': { area: 'Act 1 - Cave 2' },
          'Rakanishu': { area: 'Act 1 - Wilderness 3' },
          'Treehead WoodFist': { area: 'Act 1 - Wilderness 4' },
          'Griswold': { area: 'Act 1 - Tristram' },
          'The Countess': { area: 'Act 1 - Crypt 3 E' },
          'Pitspawn Fouldog': { area: 'Act 1 - Jail 2' },
          'Boneash': { area: 'Act 1 - Cathedral' },
          'Radament': { area: 'Act 2 - Sewer 1 C' },
          'Bloodwitch the Wild': { area: 'Act 2 - Tomb 2 Treasure' },
          'Fangskin': { area: 'Act 2 - Tomb 3 Treasure' },
          'Beetleburst': { area: 'Act 2 - Desert 3' },
          'Leatherarm': { area: 'Act 2 - Tomb 1 Treasure' },
          'Coldworm the Burrower': { area: 'Act 2 - Lair 1 Treasure' },
          'Fire Eye': { area: 'Act 2 - Basement 3' },
          'Dark Elder': { area: 'Act 2 - Desert 4' },
          'The Summoner': { area: 'Act 2 - Arcane' },
          'Ancient Kaa the Soulless': { area: 'Act 2 - Tomb Tal 1' },
          'The Smith': { area: 'Act 1 - Barracks' },
          'Web Mage the Burning': { area: 'Act 3 - Spider 2' },
          'Witch Doctor Endugu': { area: 'Act 3 - Dungeon 2 Treasure' },
          'Stormtree': { area: 'Act 3 - Kurast 1' },
          'Sarina the Battlemaid': { area: 'Act 3 - Temple 1' },
          'Icehawk Riftwing': { area: 'Act 3 - Sewer 1' },
          'Ismail Vilehand': { area: 'Act 3 - Travincal' },
          'Geleb Flamefinger': { area: 'Act 3 - Travincal' },
          'Bremm Sparkfist': { area: 'Act 3 - Mephisto 3' },
          'Toorc Icefist': { area: 'Act 3 - Travincal' },
          'Wyand Voidfinger': { area: 'Act 3 - Mephisto 3' },
          'Maffer Dragonhand': { area: 'Act 3 - Mephisto 3' },
          'Infector of Souls': { area: 'Act 4 - Diablo 1' },
          'Lord De Seis': { area: 'Act 4 - Diablo 1' },
          'Grand Vizier of Chaos': { area: 'Act 4 - Diablo 1' },
          'The Cow King': { area: 'Act 1 - Moo Moo Farm' },
          'Corpsefire': { area: 'Act 1 - Cave 1' },
          'The Feature Creep': { area: 'Act 4 - Lava 1' },
          'Siege Boss': { area: 'Act 5 - Siege 1' },
          'Ancient Barbarian 1': { area: 'Act 5 - Mountain Top' },
          'Ancient Barbarian 2': { area: 'Act 5 - Mountain Top' },
          'Ancient Barbarian 3': { area: 'Act 5 - Mountain Top' },
          'Bonesaw Breaker': { area: 'Act 5 - Ice Cave 2' },
          'Dac Farren': { area: 'Act 5 - Siege 1' },
          'Megaflow Rectifier': { area: 'Act 5 - Barricade 1' },
          'Eyeback Unleashed': { area: 'Act 5 - Barricade 1' },
          'Threash Socket': { area: 'Act 5 - Barricade 2' },
          'Pindleskin': { area: 'Act 5 - Temple Entrance' },
          'Snapchip Shatter': { area: 'Act 5 - Ice Cave 3A' },
          'Sharp Tooth Sayer': { area: 'Act 5 - Barricade 1' },
          'Frozenstein': { area: 'Act 5 - Ice Cave 1A' },
          'Nihlathak Boss': { area: 'Act 5 - Temple Boss' },
          'Baal Subject 1': { area: 'Act 5 - Throne Room' },
          'Baal Subject 2': { area: 'Act 5 - Throne Room' },
          'Baal Subject 3': { area: 'Act 5 - Throne Room' },
          'Baal Subject 4': { area: 'Act 5 - Throne Room' },
          'Baal Subject 5': { area: 'Act 5 - Throne Room' },
        }
        constructor ({ inputEl, container, resolver }) {
          this.resolver = resolver
          this.inputEl = inputEl
          this.container = container
        }

        setup () {
          this.inputEl.onchange = e => {
            this.regex = new RegExp(e.target.value, 'i')
            this.set('regex', this.regex.source)
            this.update()
          }
          const regex = this.get('regex')
          if (regex && regex.length > 0) {
            this.inputEl.value = regex
            this.regex = new RegExp(regex, 'i')
            this.update()
          }
        }

        async load () {
          this.d2data = new Diablo2Data()
          await this.d2data.load()
        }

        get (key) {
          const params = new URLSearchParams(window.location.search)
          return params.get(key)
        }

        set (key, value) {
          const params = new URLSearchParams(window.location.search)
          if (typeof value !== 'string' || value.length === 0) {
            params.delete(key)
          } else {
            params.set(key, encodeURIComponent(value))
          }
          window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}${window.location.hash}`)
        }

        update () {
          const els = []
          console.log(SuperUnique.sets)
          for (const k in SuperUnique.sets) {
            if (!this.resolver.get(k)) {
              throw new Error(k)
            } else {
              console.log(this.resolver.get(k))
            }
          }
          this.d2data.supers().each(supa => {
            if (this.resolver.get(supa.Name) === this.inputEl.value) {
              els.push(supa)
            }
          })
          this.container.innerHTML = ''
          els.forEach(el => {
            const element = document.createElement('p')
            element.textContent = JSON.stringify(el)
            this.container.appendChild(element)
          })
        }
      }
      async function Load () {
        await strings.load()
        const su = await new SuperUnique({
          resolver: strings,
          inputEl: document.querySelector('#search'),
          container: document.querySelector('#content')
        })
        await su.load()
        su.setup()
      }
      requestAnimationFrame(Load)
    </script>
  </body>
</html>
