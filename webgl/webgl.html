<!doctype html>
<html>
  <head>
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <style>
      * {
        background-color: black;
        color: silver;
      }
    </style>
  </head>
  <body>
    <script>
      const n = 512
      const vertexShaderSource = `#version 300 es
        precision highp float;
        in vec4 position;
        void main() {
            gl_Position = position;
        }
      `

      const fragmentShaderSource = `#version 300 es
        precision highp float;

        layout(location = 0) out uvec4 color;

        void main() {
          color = uvec4(0u);

          for (uint i = 0u; i < ${Math.floor(100e9/n/n)}u; i++) {
            color.r = ((i >> 24u) & 0xffu) / 255u;
            color.g = ((i >> 16u) & 0xffu) / 255u;
            color.b = ((i >> 8u) & 0xffu) / 255u;
            color.a = (i & 0xffu) / 255u;
          }

          color.r = uint(gl_FragCoord.x);
          color.g = uint(gl_FragCoord.y);
        }
      `
    </script>
    <script>
      const canvas = document.createElement('canvas')
      canvas.width = n
      canvas.height = n
      const context = canvas.getContext('webgl2')

      const createShader = (source, type) => {
        const res = context.createShader(type)
        context.shaderSource(res, source)
        context.compileShader(res)
        const msg = context.getShaderInfoLog(res)
        if (msg.length > 0) {
          throw new Error(`shader compile message: ${msg}`)
        }
        return res
      }

      const createProgram = (vertex, fragment) => {
        vertex = createShader(vertex, context.VERTEX_SHADER)
        fragment = createShader(fragment, context.FRAGMENT_SHADER)
        const res = context.createProgram()
        context.attachShader(res, vertex)
        context.attachShader(res, fragment)
        context.linkProgram(res)
        if (!context.getProgramParameter(res, context.LINK_STATUS)) {
          const msg = context.getProgramInfoLog(res)
          if (msg.length > 0) {
            throw new Error(`program compile message: ${msg}`)
          }
          throw new Error('program failed')
        }
        return res
      }

      const parallelWork = () => {
        const program = createProgram(vertexShaderSource, fragmentShaderSource)

        const vertices = new Float32Array([
            -1.0, -1.0,
             1.0, -1.0,
            -1.0,  1.0,
             1.0,  1.0
        ])
        const vertexBuffer = context.createBuffer();
        context.bindBuffer(context.ARRAY_BUFFER, vertexBuffer);
        context.bufferData(context.ARRAY_BUFFER, vertices, context.STATIC_DRAW);

        const positionAttribLocation = context.getAttribLocation(program, 'position')
        context.vertexAttribPointer(positionAttribLocation, 2, context.FLOAT, false, 0, 0)
        context.enableVertexAttribArray(positionAttribLocation)

        const texture = context.createTexture()
        context.bindTexture(context.TEXTURE_2D, texture)
        context.texImage2D(context.TEXTURE_2D, 0, context.RGBA32UI, n, n, 0, context.RGBA_INTEGER, context.UNSIGNED_INT, null)

        const frame = context.createFramebuffer()
        context.bindFramebuffer(context.FRAMEBUFFER, frame)
        context.framebufferTexture2D(context.FRAMEBUFFER, context.COLOR_ATTACHMENT0, context.TEXTURE_2D, texture, 0)

        context.useProgram(program)
        context.drawArrays(context.TRIANGLE_STRIP, 0, 4)

        const res = new Uint32Array(n * n * 4)
        context.readPixels(0, 0, n, n, context.RGBA_INTEGER, context.UNSIGNED_INT, res)
        return res
      }

      performance.mark('s')
      const res = parallelWork()
      performance.mark('e')
      console.log(performance.measure('e-s', 's', 'e'))
      console.log(res)
      crypto.subtle.digest('SHA-1', res).then(el => {
        console.log(Array.from(new Uint8Array(el)).join(','))
      })
    </script>
  </body>
</html>
